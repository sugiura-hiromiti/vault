---
title: "Rustã¨WebAssemblyã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ é–‹ç™ºã‚’èª­ã¿é€²ã‚ãŸã‚‰ã¤ã¾ã¥ãã¾ãã£ãŸã®ã§å‚™å¿˜éŒ²"
emoji: "ğŸ—‚"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nix, Rust, WebAssembly, direnv, zennfes2025free]
published: true
---

findyã®oreilly learningãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒ90æ—¥ç„¡æ–™ã§è©¦ã›ã‚‹ãƒ¤ãƒ„ã®æŠ½é¸ã«å½“ãŸã£ã¦ã¾ã—ãŸ
1ãƒ¶æœˆã‚‚ãã‚Œã«æ°—ä»˜ã‹ãšæ”¾ç½®ã—ã¦ã„ãŸã‚‰ã€findyã•ã‚“ã®æ–¹ã‹ã‚‰ã€ŒæŠ½é¸å½“ãŸã£ã¦ã‚‹ã§ãƒ¼æ°—ã¥ã„ã¦ãƒ¼ã€ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¥ãŸã®ã§æ—©é€Ÿè©¦ã—ã¦ã„ã¾ã™ï¼ˆfindyã•ã‚“ã”ã‚ã‚“ãªã•ã„ã‚ã‚ŠãŒã¨ã†ï¼‰
æ‰‹å§‹ã‚ã«ã€è«¸äº‹æƒ…ã§åºç›¤ä»¥é™ãŒèª­ã‚ãªããªã£ã¦ã—ã¾ã£ã¦ã„ãŸ
[Rustã¨WebAssemblyã«ã‚ˆã‚‹ã‚²ãƒ¼ãƒ é–‹ç™º](https://learning.oreilly.com/library/view/rusttowebassemblyniyorugemukai-fa-an-quan-gao-su-puratutohuomufei-yi-cun-nowebapurikai-fa-ru-men/9784814400393/)
ã¨ã„ã†æœ¬ã‚’èª­ã¿é€²ã‚ã¦ã„ã¾ã™

æœ¬ã®æ‰±ã£ã¦ã„ã‚‹å†…å®¹ãŒç™ºå±•é€”ä¸Šã®åˆ†é‡ãªç‚ºå¤‰åŒ–ãŒæ—©ãã€ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„æ–¹ãªã©ã¯ç‰¹ã«è©°ã¾ã‚Šã‚„ã™ã„ãªã¨æ€ã£ãŸã®ã§å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã™ã“ã¨ã«ã—ã¾ã—ãŸ

èª­ã¿é€²ã‚ã¦ã„ãéš›è©°ã¾ã‚‹ã¨ã“ã‚ãŒå‡ºã¦ãã‚‹ã¨æ€ã†ã®ã§ã€è¨˜äº‹ã®æ–¹ã‚‚ãã®éƒ½åº¦æ›´æ–°ã—ã¦ã„ãæ–¹é‡ã§æ›¸ã„ã¦ã„ãã¾ã™

> [!caution]
>
> - ä»¥ä¸‹ã€2025/10æ™‚ç‚¹ã§ã®æƒ…å ±ã§ã™
> - æƒ³å®šã™ã‚‹èª­è€…å±¤ã¯2025/10/01æ™‚ç‚¹ã§ã®è‡ªåˆ†ã§ã™
> - â†‘è¦ã¯é§†ã‘å‡ºã—ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢

# 1ç« 

## rustupã®ä»£ã‚ã‚Šã«nixã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã®æ³¨æ„ç‚¹

è‡ªåˆ†ã¯ [fenix](https://github.com/nix-community/fenix) ã¨ã„ã†overlayã‚’åˆ©ç”¨ã—ã¦rustã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™
æ™®é€šã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã¨`cargo`ã²ã„ã¦ã¯`rustc`ã‚³ãƒãƒ³ãƒ‰ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¯ãƒ›ã‚¹ãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã«ãªã£ã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™
ãŸã¨ãˆã°è‡ªåˆ†ã¯ã€apple siliconã®macãªã®ã§

```sh
â¯ rustc -v -V
rustc 1.92.0-nightly (dc2c3564d 2025-09-29)
binary: rustc
commit-hash: dc2c3564d273cf8ccce32dc4f47eaa27063bceb9
commit-date: 2025-09-29
host: aarch64-apple-darwin # â†ã“ã‚ŒãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
release: 1.92.0-nightly
LLVM version: 21.1.2
```

ã¨ãªã£ã¦ã„ã¾ã™

wasmï¼ˆå…·ä½“çš„ã«ã€ä»Šå›ã®å ´åˆã¯wasm32-unknown-unknown)ã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã€
rustupã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã¯å˜ç´”ã«`rustup`ã‚³ãƒãƒ³ãƒ‰çµŒç”±ã§wasm32-unknown-unknownã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°è‰¯ã„ã®ã§ã™ãŒã€rustupã‚’ä½¿ã‚ãªã„å ´åˆã¯åˆ¥ã®æ–¹æ³•ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

è‡ªåˆ†ã®å ´åˆã¯devshellã‚’åˆ©ç”¨ã—ã¦ç’°å¢ƒæ§‹ç¯‰ã‚’ã—ã¦ã„ã‚‹ã®ã§ã€flake.nixã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¾ã™

```nix
{
  inputs = {
    nixpkgs.url = "github:nixos/nixpkgs/nixpkgs-unstable";
    flake-utils.url = "github:numtide/flake-utils";
    fenix.url = "github:nix-community/fenix";
    fenix.inputs.nixpkgs.follows = "nixpkgs";
  };

  outputs =
    {
      self,
      nixpkgs,
      flake-utils,
      fenix,
    }:
    flake-utils.lib.eachDefaultSystem (
      system:
      let
        pkgs = nixpkgs.legacyPackages.${system};
        fx = fenix.packages.${system};
        toolchain = fx.combine [
          fx.latest.rustc
          fx.latest.cargo
          fx.latest.rustfmt
          fx.latest.clippy
          fx.latest.rust-src
          fx.targets.wasm32-unknown-unknown.latest.rust-std
        ];
      in
      {
        devShells.default = pkgs.mkShell {
          buildInputs = [
            pkgs.nodejs_24
            pkgs.wasm-pack
            toolchain
          ];

          shellHook = ''
            echo -e "\033[1;32m\nRust + WASM dev environment loaded"
            echo -e "System: ${system}"
            echo -e "wasm-pack: $(which wasm-pack 2>/dev/null || echo 'not found')"
            echo -e "rustc:     $(which rustc 2>/dev/null || echo 'not found')"
            echo -e "cargo:     $(which cargo 2>/dev/null || echo 'not found')\033[0m\n"
          '';
        };
      }
    );
}
```

> [!tip]
> shellHookã§å®Ÿè¡Œã—ã¦ã„ã‚‹ echo å†…ã«\033[1 ... ã¨è¦‹æ…£ã‚Œã¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã‚Œã¯ansi escape
> sequence ã¨ã„ã†ã‚‚ã®ã§ã™
> ansi escape sequenceè‡ªä½“ã®èª¬æ˜ã¯
> https://stackoverflow.com/questions/4842424/list-of-ansi-color-escape-sequences
> â†‘ã®ãƒªãƒ³ã‚¯ã®å›ç­”ãŒã‚ã‹ã‚Šã‚„ã™ã„ã§ã™

`fx.combine`ã«æ¸¡ã•ã‚Œã‚‹é…åˆ—å†…ã§ç¤ºã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ã²ã¨ã¾ã¨ã¾ã‚Šã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹ï¼ˆã¨ã„ã†ç†è§£ãªã‚“ã§ã™ã‘ã©åˆã£ã¦ã‚‹ï¼Ÿï¼‰
ã®ã§ã€ã‚ã¨ã¯`toolchain`ã‚’buildInputsã«æŒ‡å®šã—ã¦ã‚„ã‚Œã°wasm32-unknown-unknownå•é¡Œã¯è§£æ±ºã—ã¾ã™

shellã§rustcã®ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†

```sh
â¯ wh rustc
rustc is /nix/store/nixqji36ybcpjipvq5xh17i9zimmn58a-rust-mixed/bin/rustc
rustc is /Users/a/.nix-profile/bin/rustc
```

devshellã®ãƒ‘ã‚¹ãŒå…ˆã«æ¥ã¦ãŸã‚‰OKã§ã™
ç¨€ã«neovimã®terminalãƒãƒƒãƒ•ã‚¡ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªæ–¹ãŒå…ˆã«æ¥ã¦ã—ã¾ã†ã®ã§ã™ãŒã€
ãã®çŠ¶æ…‹ã§`npm run start`ã™ã‚‹ã¨

```
Error: wasm32-unknown-unknown target not found in sysroot: "/nix/store/7qqwr576zn72lib96j4kig162agh4cb9-rust-nightly-latest-2025-09-30"

Used rustc from the following path: "/Users/a/.nix-profile/bin/rustc"
It looks like Rustup is not being used. For non-Rustup setups, the wasm32-unknown-unknown target needs to be installed manually. See https://rustwasm.github.io/wasm-pack/book/prerequisites/non
-rustup-setups.html on how to do this.
```

ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã§ã€devshellã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ã‚‡ã†
è‡ªåˆ†ã®å ´åˆã¯direnvã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã§ä¸€æ—¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŠœã‘ã¦æˆ»ã‚‹ã¨è§£æ±ºã—ã¾ã™

## ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå¤ã„

æœ¬ã®ä¸­ã§ã‚‚è¨€åŠã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã ã„ã¶å¤ããªã£ã¦ã„ã¾ã™
`npm init rust-webpack`ã§ç”Ÿæˆã•ã‚Œã‚‹Cargo.tomlã®ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã¯ãªã‚“ã¨2018..
æœ¬ã®ä¸­ã§ã‚‚è»½ãã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€ãã‚Œã§ã‚‚ã¾ã å¤ã„ã®ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã„ã¾ã—ãŸ
ã¨ã„ã†ã“ã¨ã§ã€æœ¬è…°ã‚’å…¥ã‚Œã¦æ›´æ–°ä½œæ¥­ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

### ç›®æ¨™

ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§"Hello World!"ã¨å‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã®ã‚’ç¢ºèªã™ã‚‹

å› ã¿ã«ã€`npm init rust-webpack`ã§ç”Ÿæˆã•ã‚Œã‚‹`src/lib.rs`ã¯â†“ã§ã™

```rust
use wasm_bindgen::prelude::*;
use web_sys::console;

// When the `wee_alloc` feature is enabled, this uses `wee_alloc` as the global
// allocator.
//
// If you don't want to use `wee_alloc`, you can safely delete this.
#[cfg(feature = "wee_alloc")]
#[global_allocator]
static ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;

// This is like the `main` function, except for JavaScript.
#[wasm_bindgen(start)]
pub fn main_js() -> Result<(), JsValue,> {
	// This provides better error messages in debug mode.
	// It's disabled in release mode so it doesn't bloat up the file size.
	#[cfg(debug_assertions)]
	console_error_panic_hook::set_once();

	// Your code goes here!
	console::log_1(&JsValue::from_str("Hello world!",),);

	Ok((),)
}
```

### Rustå´

å®Ÿã¯Rustå´ã®æ›´æ–°ã¯ãã‚“ãªã«å¤§å¤‰ã§ã¯ã‚ã‚Šã¾ã›ã‚“
Cargo.tomlã‚’ã„ã˜ã‚‹ã ã‘ã§ã™
è‡ªåˆ†ã®å ´åˆã¯â†“ãªæ„Ÿã˜ã«ã—ã¾ã—ãŸ

```toml
# You must change these to your own details.
[package]
name = "rust-webpack-template"
version = "0.1.0"
authors = ["You <you@example.com>"]
categories = ["wasm"]
edition = "2024"
readme = "README.md"
description = "My super awesome Rust, WebAssembly, and Webpack project!"

[lib]
crate-type = ["cdylib"]

[profile.release]
# This makes the compiled code faster and smaller, but it makes compiling slower,
# so it's only enabled in release mode.
lto = true

[features]
# If you uncomment this line, it will enable `wee_alloc`:
# default = ["wee_alloc"]

[dependencies]
# The `wasm-bindgen` crate provides the bare minimum functionality needed
# to interact with JavaScript.
wasm-bindgen = "*"
console_error_panic_hook = "*"

# `wee_alloc` is a tiny allocator for wasm that is only ~1K in code size
# compared to the default allocator's ~10K. However, it is slower than the default
# allocator, so it's not enabled by default.
wee_alloc = { version = "*", optional = true }

# The `web-sys` crate allows you to interact with the various browser APIs,
# like the DOM.
[dependencies.web-sys]
version = "*"
features = ["console"]

# The `console_error_panic_hook` crate provides better debugging of panics by
# logging them with `console.error`. This is great for development, but requires
# all the `std::fmt` and `std::panicking` infrastructure, so it's only enabled
# in debug mode.

# These crates are used for running unit tests.
[dev-dependencies]
futures = "*"
js-sys = "*"
wasm-bindgen-futures = "*"
wasm-bindgen-test = "*"
```

### js(ãƒ„ãƒ¼ãƒ«)å´

ã“ã¡ã‚‰ã¯å¤§å¤‰ã§ã™..ã¨ã„ã†ã‹å¤§å¤‰ã§ã—ãŸ

ãŒã€çµå±€ã‚„ã‚‹äº‹ã¨ã—ã¦ã¯

1. package.jsonã®ä¿®æ­£
2. webpack.config.jsã®ä¿®æ­£

ã®äºŒã¤ã§ã™

#### package.jsonã®ä¿®æ­£

```json
{
	"author": "You <you@example.com>",
	"name": "rust-webpack-template",
	"version": "0.1.0",
	"scripts": {
		"build": "webpack --mode production",
		"start": "webpack serve --open --mode development",
		"test": "cargo test && wasm-pack test --headless"
	},
	"devDependencies": {
		"@wasm-tool/wasm-pack-plugin": "*",
		"copy-webpack-plugin": "^5.0.3",
		"webpack": "^5.102.0",
		"webpack-cli": "^5.1.4",
		"webpack-dev-server": "*"
	}
}
```

æ­£ç›´nodeã®ä½¿ã„æ–¹ã¨ã‹webpackå´ã®äº‹æƒ…ã¨ã‹çŸ¥ã£ãŸã“ã£ã¡ã‚ƒãªã®ã§è’ã„ä¿®æ­£ãªã®ã¯è‡ªè¦šã—ã¦ã„ã¾ã™
ã¨ã‚Šã‚ãˆãšã“ã‚Œã§å‹•ãã‹ã‚‰ãˆãˆã­ã‚“ã®ç²¾ç¥ã§è‡ªåˆ†ã«è¨€ã„è¨³ã—ã¦ã„ã¾ã™ãŒã€æŒ‡æ‘˜ãªã©ã‚ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„
æ¶å‚ã‚‰ã—ã¦å–œã³ã¾ã™

ä¿®æ­£ç‚¹ã¨ã—ã¦ã¯webpackãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã ã¨ï¼”ç³»ãªã®ã§ï¼•ç³»ã«ï¼‰ã¨ãã‚Œã«ä¼´ã£ãŸãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ã®å¤‰æ›´ã§ã™

#### webpack.config.js

```js
const path = require("path");
const WasmPackPlugin = require("@wasm-tool/wasm-pack-plugin");
const CopyWebpackPlugin = require("copy-webpack-plugin");

module.exports = {
  mode: "development",
  entry: "./js/index.js",
  // å¿…è¦
  output: {
    path: path.resolve(__dirname, "dist"),
    filename: "main.js",
    publicPath: "auto",
    clean: true,
  },
  experiments: {
    asyncWebAssembly: true,
    topLevelAwait: true,
  },
  module: {
    rules: [{ test: /\.wasm$/, type: "webassembly/async" }],
  },
  resolve: { extensions: [".js", ".wasm"] },
  // å¿…è¦
  devServer: {
    static: path.join(__dirname, "static"),
    hot: true,
    port: 8081,
  },
  devtool: "source-map",
  plugins: [
    new WasmPackPlugin({
      crateDirectory: path.resolve(__dirname),
      outDir: path.resolve(__dirname, "pkg"),
      extraArgs: "--target bundler",
      forceMode: "development",
    }),
    // å¿…è¦
    new CopyWebpackPlugin([
      { from: path.resolve(__dirname, "static"), to: path.resolve(__dirname, "dist") },
    ]),
  ],
};
```

ã“ã¡ã‚‰ã‚‚ã¨ãƒ»å‹•ãƒ»ãˆç²¾ç¥ã§ã”ã¡ã‚ƒã”ã¡ã‚ƒã‚’è¨±å®¹ã—ã¦ã„ã¾ã™
æŒ‡æ‘˜ãªã©ã‚ã£ãŸã‚‰(ry

ä¿è¨¼ã¯ã§ãã¾ã›ã‚“ãŒã€â†‘ã§*å¿…è¦*ã¨ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ­ãƒƒã‚¯ã«é–¢ã—ã¦ã¯æœ€ä½é™å¿…è¦ãªè¨­å®šã‹ã¨æ€ã‚ã‚Œã¾ã™
ã“ã„ã¤ã‚‰ãŒãªã„ã¨ãƒ“ãƒ«ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã¡ã‚ƒã‚“ã¨ä½¿ã£ã¦ãã‚Œãªããªã‚Šã¾ã™

### ç¢ºèªã—ã¦ã¿ã‚ˆã†

ã“ã“ã¾ã§ä¿®æ­£ã™ã‚Œã°ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«`console::log_1`ã¸æ¸¡ã—ãŸå€¤ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ã¨æ€ã„ã¾ã™

ã•ã‚Œã¦ã„ãªã„å ´åˆã¯wasmã‚’èª­ã¿è¾¼ã‚€jså´ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã€ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã—ã‚‡ã†

```js
import "../pkg/index.js";
```

`webpack.config.js`ã‚’å†æ²ã™ã‚‹ã¨ã€è‡ªåˆ†ã¯â†“ã®ã‚ˆã†ã«js/index.jsã‚’ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã«æŒ‡å®šã—ã¦ã„ã¾ã™

```js
const path = require("path");
const WasmPackPlugin = require("@wasm-tool/wasm-pack-plugin");
const CopyWebpackPlugin = require("copy-webpack-plugin");

module.exports = {
  mode: "development",
  entry: "./js/index.js",
  // å¿…è¦
  output: {
    path: path.resolve(__dirname, "dist"),

...
```

## å€‹äººçš„tips

rustã§å¤–éƒ¨ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã‚ˆããŠä¸–è©±ã«ãªã‚‹ [docs.rs](https://docs.rs/)
ã§ã™ãŒã€å®Ÿã¯type based searchãŒã§ãã¾ã™

ä¾‹ãˆã°ã€web_sysã‚¯ãƒ¬ãƒ¼ãƒˆã§

&JsValue -> HtmlCanvasElement

ã¨æ¤œç´¢ã™ã‚‹ã¨â†“ã®ã‚ˆã†ãªçµæœãŒå¾—ã‚‰ã‚Œã¾ã™

https://docs.rs/web-sys/latest/web_sys/struct.Element.html?search=%26JsValue%20-%3E%20HtmlCanvasElement

æ„å¤–ã¨çŸ¥ã‚‰ã‚Œã¦ãªã„ã“ã®æ©Ÿèƒ½ã§ã™ãŒã€ğŸ”(Search)ãƒœã‚¿ãƒ³ã®å³ã«ã‚ã‚‹?(Help)ãƒœã‚¿ãƒ³ã‚’ãŠã™ã¨ã‚¬ãƒƒãƒ„ãƒªç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™
çµæ§‹æŸ”è»Ÿã«ã‚¯ã‚¨ãƒªãŒæ›¸ã‘ã¦ä¾¿åˆ©ã§ã™

docs.rsã‚’å¾˜å¾Šã™ã‚‹æ™‚ã«è¨˜æ†¶ã®ç«¯ã£ã“ã«ã‚ã‚‹ã¨ã‚ªã‚¤ã‚·ã‚¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“

## ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°å–å¾—

ãƒ©ãƒ³ãƒ€ãƒ ãªæ•°ã‚’å–å¾—ã™ã‚‹ãŸã‚ã« [rand](https://docs.rs/rand/latest/rand/)
ã‚¯ãƒ¬ãƒ¼ãƒˆã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€ãã®ã¾ã¾ã§wasm32-unknown-unknownå‘ã‘ã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™

```
error: The wasm32-unknown-unknown targets are not supported by default; you may need to enable the "wasm_js" configuration flag. Note that enabling the `wasm_js` feature flag alone is insufficient. For more information see: https://docs.rs/getrandom/0.3.3/#webassembly-support
   --> /Users/a/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/getrandom-0.3.3/src/backends.rs:168:9
    |
168 | /         compile_error!(concat!(
169 | |             "The wasm32-unknown-unknown targets are not supported by default; \
170 | |             you may need to enable the \"wasm_js\" configuration flag. Note \
171 | |             that enabling the `wasm_js` feature flag alone is insufficient. \
172 | |             For more information see: \
173 | |             https://docs.rs/getrandom/", env!("CARGO_PKG_VERSION"), "/#webassembly-support"
174 | |         ));
    | |__________^

error[E0425]: cannot find function `fill_inner` in module `backends`
  --> /Users/a/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/getrandom-0.3.3/src/lib.rs:99:19
   |
99 |         backends::fill_inner(dest)?;
   |                   ^^^^^^^^^^ not found in `backends`

error[E0425]: cannot find function `inner_u32` in module `backends`
   --> /Users/a/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/getrandom-0.3.3/src/lib.rs:128:15
    |
128 |     backends::inner_u32()
    |               ^^^^^^^^^ not found in `backends`
    |
help: consider importing this function
    |
 33 + use crate::util::inner_u32;
    |
help: if you import `inner_u32`, refer to it directly
    |
128 -     backends::inner_u32()
128 +     inner_u32()
    |

error[E0425]: cannot find function `inner_u64` in module `backends`
   --> /Users/a/.cargo/registry/src/index.crates.io-1949cf8c6b5b557f/getrandom-0.3.3/src/lib.rs:142:15
    |
142 |     backends::inner_u64()
    |               ^^^^^^^^^ not found in `backends`
    |
help: consider importing this function
    |
 33 + use crate::util::inner_u64;
    |
help: if you import `inner_u64`, refer to it directly
    |
142 -     backends::inner_u64()
142 +     inner_u64()
    |
```

ã“ã‚Œã¯randãŒä¾å­˜ã™ã‚‹[getrandom](https://docs.rs/getrandom/latest/getrandom/)ã‚¯ãƒ¬ãƒ¼ãƒˆç”±æ¥ã®ã‚¨ãƒ©ãƒ¼ã§ã™ã­
æœ¬æ›¸ã§ã¯`Cargo.toml`ã§getrandomã®jsãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚Œã°ãˆãˆã­ã‚“ã§ã€ã£ã¦æ›¸ã„ã¦ã¾ã™ãŒã“ã‚Œã¯å¤ã„æƒ…å ±ã§ã™

ã˜ã‚ƒã‚ã©ã†ã™ã‚Œã°è‰¯ã„ã®ï¼Ÿã£ã¦ã„ã†ã¨[ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã®ãƒªãƒ³ã‚¯](https://docs.rs/getrandom/0.3.3/#webassembly-support)
ãŒæ­£ã—ãæ±‚ã‚ã¦ã„ãŸã‚‚ã®ãªã‚“ã§ã™ãŒã€è¦‹è½ã¨ã—ã‚„ã™ã„ç®‡æ‰€ãŒã‚ã‚‹ã®ã§ã‚ã‚‚

### getrandomã‚¯ãƒ¬ãƒ¼ãƒˆã®è¨­å®š

è¦ã¯ä»¥ä¸‹ã®2ã¤ã‚’**ä¸¡æ–¹ã¨ã‚‚**è¨­å®šã™ã‚‹ã¨è§£æ¶ˆã—ã¾ã™

1. "wasm_js"ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’è¨­å®šã™ã‚‹
2. wasm32-unknown-unknownã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã¯getrandom_backendãƒ•ãƒ©ã‚°ã‚’"wasm_js"ã«ã™ã‚‹

1ç•ªã¯ãã®ã¾ã¾

```toml
getrandom = { version = "*", features = ["wasm_js"] }
```

ã¨ã—ã¦ã‚„ã‚Œã°ãŠk

> å€‹äººçš„ã«ã¯çµæ§‹ã³ã£ãã‚Šãªã‚“ã§ã™ãŒã€åˆ©ç”¨ã‚¯ãƒ¬ãƒ¼ãƒˆãŒä¾å­˜ã—ã¦ã‚‹ã‚¯ãƒ¬ãƒ¼ãƒˆã®è¨­å®šã£ã¦è‡ªèº«ã®Cargo.tomlã‹ã‚‰å¼„ã‚Œã‚‹ã‚“ã§ã™ã­
> ã¾ããã‚ŒãŒå‡ºæ¥ãªã„ã¨å›°ã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã¨è¨€ã†ã®ã¯æƒ³åƒã«é›£ããªã„ã¨ã„ã†ã‹æ­£ã—ãâ†‘ã®ã‚±ãƒ¼ã‚¹ãŒè©²å½“ã—ã¾ã™ã‚ˆã­
> å¤šåˆ†ä¸€ç•ªé©šã„ã¦ã„ã‚‹ã®ã¯ã€ãã®è¨­å®šã®ä»•æ–¹ã ã¨æ€ã„ã¾ã™
> randã‚¯ãƒ¬ãƒ¼ãƒˆãŒä¾å­˜ã—ã¦ã„ã‚‹getrandomã®è¨­å®šã¯~~ã£ã¦è¨€ã†æ›¸ãæ–¹ãªã‚‰åˆ†ã‹ã‚‹ã‚“ã§ã™ãŒã€ãªã‚“ã®ç¸›ã‚Šã‚‚ç„¡ã—ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼Ÿã«ãƒœãƒ³ã£ã¨ç½®ã„ã¡ã‚ƒã£ã¦å¤§ä¸ˆå¤«ãªã‚“ã§ã—ã‚‡ã†ã‹
> è±å½¢ä¾å­˜ã—ã¦ã‚‹æ™‚ã¨ã‹ã©ã†ã™ã‚‹ã‚“ã ..?
>
> ä½™è«‡çµ‚ã‚ã‚Š

2ç•ªã¯ã€ã‚³ãƒãƒ³ãƒ‰ã‚’èµ°ã‚‰ã›ã‚‹éš›ã«é€ä¸€`RUST_FLAG`ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã™ã‚‹æ–¹æ³•ã¨ã€.cargo/config.tomlã«è¨­å®šã™ã‚‹æ–¹æ³•ãŒã‚ã‚Šã¾ã™
æ­£ç›´å¾Œè€…ã‚’å·®ã—ç½®ã„ã¦å‰è€…ã‚’é¸ã¶åˆ©ç‚¹ãŒä»Šå›ã®ã‚±ãƒ¼ã‚¹ã§ã¯æ€ã„å½“ãŸã‚‰ãªã„ã®ã§å¾Œè€…ã®ã¿æ›¸ãæ®‹ã—ã¾ã™

Cargo.tomlãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰è¦‹ã¦.cargo/config.tomlã«ã‚ãŸã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆãƒ»ç·¨é›†ã™ã‚Œã°è‰¯ã„ã‚ã‘ã§ã™

å†…å®¹ã¯

```toml
# It's recommended to set the flag on a per-target basis:
[target.wasm32-unknown-unknown]
rustflags = ['--cfg', 'getrandom_backend="wasm_js"']
```

wasm32-unknown-unknownã‚’ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã®ã¿æŒ‡å®šã®ãƒ•ãƒ©ã‚°ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã¨è¨€ã†è¨­å®šã§ã™

> [!tip]
> neovimã‚’ä½¿ã£ã¦ã„ã‚‹æ–¹å‘ã‘ã®å°ãƒã‚¿ã§ã™ãŒã€ä¾‹ãˆã°.cargo/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§
>
> ```sh
> nvim .cargo/config.toml
> ```
>
> ã¨ã™ã‚‹ã¨ã€ä¿å­˜ã®éš›ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã„ã¾ã™
> ã“ã‚Œã¯ã€.cargo/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã«ã‚‚é–¢ã‚ã‚‰ãšã€.cargo/é…ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ç‚ºã§ã™
> ~~ã‚‚ã†ã¡ã‚‡ã£ã¨æŸ”è»Ÿã«å¯¾å¿œã—ã¦ãã‚Œ~~ ã“ã®å ´åˆ`:write ++p`ã¨ã€
> writeã‚³ãƒãƒ³ãƒ‰ã«++pã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ã‚„ã‚Œã°ã€å¿…è¦ã«å¿œã˜ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆã‚’è¡Œãªã£ã¦ãã‚Œã¾ã™

# 2ç« 

## spawn_localãŒå¼•æ•°ã«asyncãƒ–ãƒ­ãƒƒã‚¯ã‚’å—ã‘ä»˜ã‘ãªã„

ã“ã‚Œã¯é€²ã‚æ–¹ã«ã‚ˆã£ã¦å‡ºãªã„ã“ã¨ã‚‚ã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™

è‡ªåˆ†ã®å ´åˆã¯ã€æœ¬ã«æ²¿ã£ã¦å®Ÿè£…ã‚’é€²ã‚ã€`wasm_bindgen_futures::spawn_local`ã®å¼•æ•°ã«asyncãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¸¡ã™ã¨

```
â€¢ the trait bound `{async block@src/lib.rs:292:36: 292:46}: futures::future::Future` is not satisfied
the following other types implement trait `futures::future::Future`:
&'a mut F
futures::future::and_then::AndThen<A, B, F>
futures::future::catch_unwind::CatchUnwind<F>
futures::future::either::Either<A, B>
futures::future::empty::Empty<T, E>
futures::future::flatten::Flatten<A>
futures::future::from_err::FromErr<A, E>
futures::future::fuse::Fuse<A>
and 44 others [E0277]
lib.rs:291:1: required by a bound introduced by this call
legacy_shared.rs:100:7: required by a bound in `wasm_bindgen_futures::spawn_local`
```

ã¨è¨€ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã„ã¾ã—ãŸ
å…ˆã«å¯¾ç—‡ç™‚æ³•ã‚’æ›¸ãã¨ã€ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯

```toml
[dependencies.wasm-bindgen-futures]
version = "*"
```

æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®wasm-bindgen-futures(ãŠãã‚‰ã0.4ç³»ä»¥ä¸Š)ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸä¸Šã§
Cargo.lockã‚’å‰Šé™¤ã™ã‚Œã°æ²»ã‚‹ã¯ãš

### åŸå› ï¼ˆå¤šåˆ†ï¼‰

ã“ã‚Œã ã‘ã ã¨è‡ªåˆ†ãŒæ°—æŒã¡æ‚ªã„ã®ã§ã€å¾Œä»˜ã‘ã§ã™ãŒã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸåŸå› ã‚’æ¨æ¸¬ã—ã¦ã¿ã¾ã™

ã¾ãšã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã„ã‚‹æ™‚ã®Cargo.lockã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜è¿°ãŒã‚ã‚Šã¾ã™

```toml
[[package]]
name = "wasm-bindgen-futures"
version = "0.3.27"
source = "registry+https://github.com/rust-lang/crates.io-index"
checksum = "83420b37346c311b9ed822af41ec2e82839bfe99867ec6c54e2da43b7538771c"
dependencies = [
	"cfg-if 0.1.10",
	"futures 0.1.31",
	"js-sys",
	"wasm-bindgen",
	"web-sys",
]
```

wasm-bindgen-futuresã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ0.3.27ã«ãªã£ã¦ã„ã¾ã™
ã“ã®çŠ¶æ…‹ã§hover docã—ã¦`wasm_bindgen_futures::spawn_local`ã®ã‚·ã‚°ãƒãƒãƒ£ã‚’ç¢ºèªã™ã‚‹ã¨

```rust
pub fn spawn_local<F>(future: F)
where
    F: Future<Item = (), Error = ()> + 'static,
```

ã¨ãªã£ã¦ã„ã¾ã™
ä¸€æ–¹ã€asyncãƒ–ãƒ­ãƒƒã‚¯ã®å‹ã¯

![type of async_block](/assets/async_block.jpeg)

ãªã‚“ã‹è¦‹é›£ã„ã§ã™ãŒ

```rust
impl Future<Output = ()>
```

ã«ãªã£ã¦ã„ã¾ã™
asyncãƒ–ãƒ­ãƒƒã‚¯ã¯è¨€èªæ©Ÿèƒ½ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ãªã®ã§core::future::Futureãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ã¾ã™
ä¸€æ–¹

wasm_bindgen_futuresã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³0.3.27æ™‚ç‚¹ã§ã¯`spawn_local`ã®å¼•æ•°ã¯ä»¥ä¸‹ã®é€šã‚Š

https://docs.rs/wasm-bindgen-futures/0.3.27/wasm_bindgen_futures/fn.spawn_local.html

ãƒãƒ¼ã‚¸ãƒ§ãƒ³0.1.28ã®futuresãƒˆãƒ¬ã‚¤ãƒˆãŒæä¾›ã™ã‚‹`futures::future::Future`ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ãŸå‹ã€ã«ãªã£ã¦ã„ã¾ã™
ã“ã“ãŒãƒŸã‚¹ãƒãƒƒãƒã—ã¦ã„ãŸç‚ºã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã„ãŸã‚ã‘ã§ã™ã­

æ†¶æ¸¬ã§ã™ãŒã€wasm_bindgen_futuresã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³0.3.27ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ä»¥é™ã«éåŒæœŸRustã®è¨€èªä½¿ç”¨ã«å¤‰æ›´ãŒå…¥ã‚Šã€
ãã®å½±éŸ¿ã‚’å—ã‘ã¦wasm_bindgen_futuresã‚¯ãƒ¬ãƒ¼ãƒˆã¯`core::future::Future`ã«æº–æ‹ ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€ã£ã¦äº‹ãŒã‚ã£ãŸã‚“ã ã¨æ€ã„ã¾ã™ï¼ˆé©å½“ï¼‰

> [!tip]
> ã¾ãŸã¾ãŸä½™è«‡ã§ã™
> docs.rsã§ã¯éå»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚€äº‹ãŒã§ãã¾ã™
> ![how to switch crate version on docs.rs](/assets/docs_rs_version.jpeg)

## `set_onload`ã«æ¸¡ã™ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£ãƒ¼ã®å¼•æ•°

> ã¤ã¾ã¥ã„ãŸäº‹ã§ã¯ç„¡ã„ã®ã§ã™ãŒã€æ°—ã«ãªã£ãŸã®ã§ã‚„ã£ã¦ã¿ãŸï¼ã¨è¨€ã†ç¯€ã§ã™

æœ¬ã§ã¯set_onloadã¨set_onerrorã«å¯¾ã—ã¦åˆ¥ã€…ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™
oneshotãƒãƒ£ãƒ³ãƒãƒ«ã‚’Mutexã§å…±æœ‰ã™ã‚‹ã¨ã„ã†éåŒæœŸRustã®å°å…¥ã¨ã—ã¦ã¶ã¡è¾¼ã‚“ã ã‚‚ã®ã¨æ€ã‚ã‚Œã¾ã™ãŒã€ã“ã®2ã¤ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯1ã¤ã«çºã‚ã‚‰ã‚Œã¾ã™

ã¨è¨€ã†ã®ã‚‚MDNã‚’è¦‹ã¦ã„ã¦æ°—ã«ãªã£ãŸã®ã§ã™ãŒã€
[onload](https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event)ã¨[onerror](https://developer.mozilla.org/en-US/docs/Web/API/Window/error_event)ã«ã‚ãŸã‚‹ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®å¼•æ•°ï¼ˆJSå´ã®è©±ã§ã™ï¼‰ãŒã©ã¡ã‚‰ã‚‚Eventã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ãªã£ã¦ã„ã¾ã™
UIç”±æ¥ã®ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ErrorEventã‚„ã§ãƒ¼ã£ã¦æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ãã®ã‚±ãƒ¼ã‚¹ã§ã¯ç„¡ã„ã®ã§å®Ÿã¯2ã¤ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ã‚·ã‚°ãƒãƒãƒ£ã¯åŒã˜ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™

ã‚·ã‚°ãƒãƒãƒ£ãŒåŒã˜ãªã‚‰çºã‚ã‚‰ã‚Œã‚‹ã®ã§ã¯ï¼Ÿã¨æ€ã£ã¦è©¦ã—ã¦ã¿ã¾ã—ãŸâ†“

```rust
			let (tx, rx,) = futures::channel::oneshot::channel::<JRslt<(),>,>();

			let callback = Closure::once(|e: Event| {
				console::log_1(&e,);
				if e.type_() == "load" {
					tx.send(Ok((),),)
						.expect("failed to send success message from callback",)
				} else {
					tx.send(Err(e.into(),),)
						.expect("failed to send error message from callback",)
				};
			},);

			let image = HtmlImageElement::new()?;

			// set callback when loading asset finished
			image.set_onload(Some(callback.as_ref().unchecked_ref(),),);
			image.set_onerror(Some(callback.as_ref().unchecked_ref(),),);

			image.set_src("Idle (1).png",);
			match rx.await {
				Ok(sent_msg,) => match sent_msg {
					Ok(_,) => {
						console_log!("load success");
						ctx.draw_image_with_html_image_element(
							&image, 0.0, 0.0,
						)?
					},
					Err(e,) => {
						console_log!("error happen while loading asset");
						console::error_1(&e,)
					},
				},
				Err(e,) => {
					let e = JsValue::from_str(&e.to_string(),);
					console_log!(
						"error happen while sending message from callback"
					);
					console::error_1(&e,);
				},
			};
```

Eventå‹ã‚’åˆ©ç”¨ã™ã‚‹ç‚ºã«ã¯web_sysã®Eventãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

```toml
[dependencies.web-sys]
version = "*"
features = [
	"console",
	"Window",
	"Document",
	"Element",
	"HtmlCanvasElement",
	"CanvasRenderingContext2d",
	"HtmlImageElement",
	"Event", # â†ã‚³ãƒ¬!!
]
```

ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®æœ€åˆã§`e`å¼•æ•°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™

`web_sys::console::log_1`ãŒå—ã‘ä»˜ã‘ã‚‹å¼•æ•°ã®å‹ã¯`&JsValue`ã§ã™ãŒã€`&Event`ã‚’æ¸¡ã—ã¦ã„ã¾ã™
ã‚³ãƒ¬ãŒãªãœè¨±ã•ã‚Œã‚‹ã®ã‹ã¨ã„ã†ã¨ã€Eventå‹ãŒ`Deref<Target = JsValue>`ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹ã‚‰ã§ã™

https://docs.rs/web-sys/latest/web_sys/struct.Event.html#deref-methods-JsValue

ä¸åº¦`&String`ãŒ`&str`ã¨è¦‹ãªã•ã‚Œã‚‹ã®ã¨åŒã˜ã§ã™
Stringå‹ã¯`Deref<Target = str>`ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ç‚ºã€Stringå‹ã®å‚ç…§ã¯strå‹ã®å‚ç…§ã€ã¤ã¾ã‚Š&strã¨ã—ã¦ã‚‚è§£é‡ˆã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™
ãã—ã¦Eventå‹ã¯`Deref<Target = JsValue>`ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ç‚ºã€ãã®å‚ç…§ã‚’`&JsValue`ã¨ã—ã¦æ¸¡ã™ã“ã¨ãŒå‡ºæ¥ã¾ã™

ifã®éƒ¨åˆ†ã§`e.type_() == "load"`ã¨ã‚ã‚Šã¾ã™

```rust
if e.type_() == "load" {
	tx.send(Ok((),),)
		.expect("failed to send success message from callback",)
} else {
	tx.send(Err(e.into(),),)
		.expect("failed to send error message from callback",)
};
```

ã‚³ãƒ¬ã¯jsã«ãŠã‘ã‚‹

```js
e.type === "load"
```

ã¨åŒã˜ã§ã™
ã¨ã¾ãå‰ãã†ã«è§£èª¬é¢ã‚’ã—ã¦ãã¾ã—ãŸãŒã€
è©¦ã—ã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«`e`ã‚’å‡ºåŠ›ã™ã‚‹ã ã‘ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã¨ã“ã‚

```
[Log] Event (main.js, line 3999)
bubbles: false
cancelBubble: false
cancelable: false
composed: false
currentTarget: null
defaultPrevented: false
eventPhase: 0
isTrusted: true
returnValue: true
srcElement: <img>
target: <img>
timeStamp: 793
type: "load"
```

ã¨è¨€ã†å‡ºåŠ›ã‚’å¾—ãŸã®ã§ãã‚Œã‚’å…ƒã«æ›¸ã„ãŸã¨è¨€ã†ã ã‘

## `into_serde`ã®å¾ªç’°å‚ç…§

ï¼’ç« ã®å¾ŒåŠã§ã¯serdeã‚’ä½¿ã£ã¦jsã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆã®è¡¨ç¾ï¼‰ã‹ã‚‰jsonã‚’è§£æã™ã‚‹ãã ã‚ŠãŒã‚ã‚Šã¾ã™
æœ¬ã§ã¯ã€wasm-bindgenã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‚’è¿½åŠ ã—

```toml
[dependencies.wasm-bindgen]
version = "*"
features = ["serde-serialize"]
```

`into_serde`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦deã—ã¦ã„ã¾ã™
ã§ã™ãŒè¨³è¨»ã®ï¼“ã«ã‚‚ã‚ã‚‹é€šã‚Šã€ç¾åœ¨`into_serde`ã‚’å¾ªç’°å‚ç…§ã‚’å¼•ãèµ·ã“ã™ç‚ºéæ¨å¥¨ã¨ãªã£ã¦ã„ã¾ã™
è¨³è¨»ã«ã¯ä»£æ›¿ã¨ã—ã¦gloo-utilsã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã†æ–¹æ³•ãŒæç¤ºã•ã‚Œã¦ã„ã¾ã™ãŒã€rust-analyzerã®ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã‚’è¦‹ãŸæ„Ÿã˜gloo-utilsã‚’ä½¿ã†ã‚ˆã‚Šserde_wasm_bindgenã‚¯ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ã£ãŸæ–¹ãŒç¾æ™‚ç‚¹ã§ã¯ã‚ªã‚¹ã‚¹ãƒ¡ãªæ–¹æ³•ãªã®ã‹ãªã¨æ€ã„ã¾ã™

### serde_wasm_bindgenã‚’ä½¿ã£ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º

ã¾ãšã€Cargo.tomlã®wasm-bindgenã®è¨­å®šã¯ãã®ã¾ã¾ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†
dependenciesãƒ†ãƒ¼ãƒ–ãƒ«ã«serde-wasm-bindgenã‚’è¿½åŠ ã™ã‚Œã°å°å…¥ã¯å®Œäº†ã§ã™

> å¤šåˆ†ã“ã“ã¾ã§ã§æ°—ã«ãªã£ã¦ã‚‹äººã‚‚å¤šã„ã‹ã¨æ€ã†ã®ã§ã™ãŒã€è‡ªåˆ†ãŒå€‹äººçš„ã«é–‹ç™ºã™ã‚‹éš›ã¯åŸºæœ¬çš„ã«å…¨ã¦æœ€æ–°ã®ç‰©ã‚’ä½¿ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™
> ã„ã¤ã‚‚è„³æ­»ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰æŒ‡å®šã—ã¦ã„ã‚‹ã®ã§æ­£ç›´ã‚³ãƒ¬ä»¥å¤–ã®è¡¨è¨˜ã‚’ã‚ã‚“ã¾ã‚ŠçŸ¥ã‚‰ãªã„

```toml
serde-wasm-bindgen = "*"

[dependencies.wasm-bindgen]
version = "*"
```

ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚‹éš›ã¯`into_serde`ã®ä»£ã‚ã‚Šã«`serde_wasm_bindgen::from_value`ã‚’ä½¿ã„ã¾ã™â†“

```rust
// ä¾‹
async fn fetch_sprite_sheet_mapper(json_path: &str,) -> JRslt<Sheet,> {
	let json = fetch_json(json_path,).await?;
	let sheet: Sheet = serde_wasm_bindgen::from_value(json,).expect(
		"failed to parse js object representation into rust struct: `Sheet`",
	);
	Ok(sheet,)
}
```

å› ã¿ã«â†‘ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§å‡ºã¦ãã‚‹`JRslt`ã¨ã„ã†å‹åã€â†“ã®ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ã¾ã™

```rust
type JRslt<T,> = Result<T, JsValue,>;
```

ã‚³ãƒ¬è¦ã‚‹ï¼Ÿã£ã¦è¨€ã‚ã‚Œã‚‹ã¨å¾®å¦™ã ã‘ã©ã“ã†è¨€ã†ç´°ã‹ã„ã®ãŒå¤§äº‹ã£ã¦ä¿¡ã˜ã¦ã‚‹ ã†ã‚“

# 3ç« 

ã“ã®è¾ºã‚Šã‹ã‚‰ç’°å¢ƒè¦å› ã®ã‚¨ãƒ©ãƒ¼ã¯è½ã¡ç€ãã¾ã™
ã‚„ã£ã¨ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«é›†ä¸­ã§ãã‚‹ãœï¼
ã¨ã¯è¨€ã„ã¤ã¤æ‰ä¸‹å³äº¬ãªã‚‰æ°—ã«ãªã‚‹ã ã‚ã†ç‚¹ãŒã¡ã‚‰ã»ã‚‰ã‚ã‚‹ã®ã§ã€ãã„ã¤ã‚‰ã‚’æ‹¾ã„ä¸Šã’ã¦ç´¹ä»‹ã—ã¾ã™

## anyhowã‚¯ãƒ¬ãƒ¼ãƒˆã®ä½¿ã„æ–¹

3ç« åºç›¤ã§anyhowã‚¯ãƒ¬ãƒ¼ãƒˆãŒå°å…¥ã•ã‚Œã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®éƒ¨åˆ†ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã‚’ã—ã¾ã™
ç­†è€…ã®è¨€ã†é€šã‚Šã€anyhowã‚¯ãƒ¬ãƒ¼ãƒˆã¯å¿…è¦ååˆ†ãªæ©Ÿèƒ½ã®ã¿ã‚’æä¾›ã™ã‚‹å°ã•ãªï¼ˆã§ã‚‚ç”»æœŸçš„ï¼‰ã‚¯ãƒ¬ãƒ¼ãƒˆã§ã™
ã§ã™ãŒæ„å¤–ã¨çŸ¥ã‚‰ã‚Œã¦ã„ãªã„anyhowã‚¯ãƒ¬ãƒ¼ãƒˆã®æ©Ÿèƒ½ãŒã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ç´¹ä»‹ã—ã¾ã™

ã¾ãšã€Optionã‚’Resultã«å¤‰æ›ã™ã‚‹éš›ã€æœ¬ã§ã¯

```rust
pub fn window() -> Result<Window> {
    web_sys::window().ok_or_else(|| anyhow!("No Window Found"))
}
```

ã¨ã—ã¦ã„ã¾ã™
å‹¿è«–ã“ã‚Œã§ä½•ã‚‚å•é¡Œãªã„ã®ã§ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚‚æ›¸ã‘ã¾ã™

```rust
// `use anyhow::Result as Rslt;` ã—ã¦ã„ã¾ã™
fn window_obj() -> Rslt<Window,> {
	web_sys::window().context("no window object found",)
}
```

`context`ãƒ¡ã‚½ãƒƒãƒ‰ã¯[anyhow::Context](https://docs.rs/anyhow/latest/anyhow/trait.Context.html)ãƒˆãƒ¬ã‚¤ãƒˆã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™
anyhowã®æ–¹ã§Optionã€Resultå‹ã«å®Ÿè£…ã—ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€anyhow::Contextã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚Œã°â†‘ã®æ§˜ã«ä½¿ãˆã¾ã™

å€‹äººçš„ãªä½¿ã„åˆ†ã‘ã§ã™ãŒã€`"{}"`ãªãƒã‚¯ãƒ­ç‰¹æœ‰ã®æ©Ÿèƒ½(ã‚³ãƒ¬ã€interpolationã£ã¦è¨€ã†ã‚“ã§ã™ã­
æœ€è¿‘çŸ¥ã‚Šã¾ã—ãŸ)ãŒä½¿ã„ãŸã„æ™‚ã¯`map`ãªã‚Š`ok_or`ãªã‚Šã‚’ä½¿ã„ã€ãã†ã§ãªã„æ™‚ã¯å¾Œè€…ã‚’ä½¿ã£ã¦ã„ã¾ã™

## `Closure::once`ã®ã‚·ã‚°ãƒãƒãƒ£

`browser`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã«`Closure::once`ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ä½œã‚‹éš›ã€æœ¬ã§ã¯

```rust
pub fn closure_once<F, A, R>(fn_once: F) -> Closure<F::FnMut>
where
    F: 'static + WasmClosureFnOnce<A, R>,
{
    Closure::once(fn_once)
}
```

ã¨ã—ã¦ã„ã¾ã™ãŒã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã„ã¾ã™
ä¾‹ã«æ¼ã‚Œãšæ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã™ã‚‹ã¨å‡ºã‚‹ã‚¨ãƒ©ãƒ¼ã¨æ€ã‚ã‚Œã¾ã™
ä¿®æ­£ã—ã¾ã—ã‚‡ã†

### çµè«–

å¿™ã—ã„äººå‘ã‘ã®ã‚³ãƒ”ãƒš

```rust
use wasm_bindgen::closure::WasmClosure;
use wasm_bindgen::closure::WasmClosureFnOnce;

pub fn closure_once<F, A, R, T,>(fn_once: F,) -> Closure<T,>
where
	F: WasmClosureFnOnce<T, A, R,>, // + 'static,
	T: WasmClosure + ?Sized,        // + 'static
{
	Closure::once(fn_once,)
}
```

~~ã‚³ãƒ”ãƒšã¨ã‹ç”¨æ„ã—ãªãã¦ã‚‚`Closure::once`ã®ã‚·ã‚°ãƒãƒãƒ£ãŒã¾ã‚“ã¾ç­”ãˆãªã‚“ã ã‚ˆã­~~ ã”æ´»ç”¨ãã ã•ã„

### è§£å‰–

ã¾ãšæœ€åˆã«å›°ã‚‹ã ã‚ã†ç‚¹ã¯ã€WasmClosureFnOnceã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‹ã¨æ€ã„ã¾ã™
ã‚¨ãƒ‡ã‚£ã‚¿ã®å¤‰æ›ã«å‡ºã¦ã“ãªã„ã®ã§å¿ƒé…ã«ãªã‚Šã¾ã™

ã¨ã‚Šã‚ãˆãšå®Ÿè£…ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†
ç¾æ™‚ç‚¹ã§wasm-bindgenã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯0.2.104ãªã®ã§0.2.104ãƒªãƒªãƒ¼ã‚¹æ™‚ã®`Closure`ã®å®Ÿè£…å‘¨ã‚Šã‚’è¦‹ã¦ã¿ã¾ã™

[ã“ã¡ã‚‰](https://github.com/wasm-bindgen/wasm-bindgen/tree/4ea9d98ce6448028743534ecc5584af28446fd2e)ã¯0.2.104ãƒªãƒªãƒ¼ã‚¹æ™‚ã®ãƒªãƒã‚¸ãƒˆãƒªå…¨ä½“ã§ã™
`Closure`ã®å®Ÿè£…ã¯[src/closure.rs](https://github.com/wasm-bindgen/wasm-bindgen/blob/4ea9d98ce6448028743534ecc5584af28446fd2e/src/closure.rs)ã«ã‚ã‚Šã¾ã™

src/closure.rsã®å†…ã€`Closure::once`ã¨é–¢ä¿‚ã®ã‚ã‚‹éƒ¨åˆ†ãŒã“ã¡ã‚‰

```rust
pub struct Closure<T: ?Sized> {
    js: ManuallyDrop<JsValue>,
    data: OwnedClosure<T>,
}

impl<T> Closure<T>
where
    T: ?Sized + WasmClosure,
{
    pub fn wrap(data: Box<T>) -> Closure<T> {
        let data = OwnedClosure {
            inner: ManuallyDrop::new(data),
        };
        Self {
            js: ManuallyDrop::new(crate::__rt::wbg_cast(&data)),
            data,
        }
    }

    pub fn once<F, A, R>(fn_once: F) -> Self
    where
        F: WasmClosureFnOnce<T, A, R>,
    {
        Closure::wrap(fn_once.into_fn_mut())
    }
}

#[doc(hidden)]
pub trait WasmClosureFnOnce<FnMut: ?Sized, A, R>: 'static {
    fn into_fn_mut(self) -> Box<FnMut>;

    fn into_js_function(self) -> JsValue;
}

#[doc(hidden)]
pub unsafe trait WasmClosure: WasmDescribe {
    const IS_MUT: bool;
}
```

ãŠç›®å½“ã¦ã®`WasmClosureFnOnce`ãƒˆãƒ¬ã‚¤ãƒˆã«`doc(hidden)`ã¨è¨€ã†å±æ€§ãŒä»˜ä¸ã•ã‚Œã¦ã„ã¾ã™
ã“ã‚ŒãŒã¤ã„ã¦ã„ã‚‹ã¨docs.rsã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œãªã‹ã£ãŸã‚Šã€rust-analyzerã®è£œå®Œå€™è£œã«å‡ºãªããªã£ãŸã‚Šã™ã‚‹ã‚“ã§ã™ã£ã¦
ã‚ã‚‰ä¾¿åˆ©

ãŸã ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«å®£è¨€ã•ã‚Œã¦ã„ã‚‹ã®ã§`use wasm_bindgen::closure::WasmClosureFnOnce;`ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯å•é¡Œãªã„ã€ã¨è¨€ã†è¨³ã§ã™
`WasmClosure`ãƒˆãƒ¬ã‚¤ãƒˆã«ã¤ã„ã¦ã‚‚åŒæ§˜
ã“ã¡ã‚‰ã¯ãŠã©ã‚ãŠã©ã‚ã—ãã‚‚`unsafe`ä¿®é£¾ã•ã‚Œã¦ã¾ã™ãŒã€ãƒˆãƒ¬ã‚¤ãƒˆã«ä»˜ã`unsafe`ã¯ç”¨æ³•ãŒã¡ã‚‡ã£ã¨ç‰¹æ®Šãªã®ã§ä»Šå›ã®æ§˜ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹åˆ†ã«ã¯å•é¡Œã‚ã‚Šã¾ã›ã‚“

æ¬¡ã«ã€çµå±€`closure_once`ã®ã‚·ã‚°ãƒãƒãƒ£ã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ï¼Ÿå•é¡Œ

ã¾ãšæ•´ç†ã™ã‚‹ã¨ã€ãƒ©ãƒƒãƒ‘ãƒ¼ãªã®ã§`Closure::once`ã¨åŒã˜ã‚·ã‚°ãƒãƒãƒ£ã«ã—ãŸã„ã¨è¨€ã†å‰æãŒã‚ã‚Šã¾ã™
â†‘ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾è»¢ç”¨ã™ã‚‹ã¨

```rust
pub fn closure_once<F, A, R>(fn_once: F) -> Self
where
    F: WasmClosureFnOnce<T, A, R>,
{
    Closure::once(fn_once)
}
```

ã»ã¼å®Œæˆå½¢ã§ã™ãŒã€ã‚¸ã‚§ãƒãƒªãƒƒã‚¯å‹å¤‰æ•°`T`ã‚„Selfã¯`impl Closure`ã®æ–‡è„ˆå¤–ã§ã¯é€šã˜ã¾ã›ã‚“
ã“ã„ã¤ã‚‰ãŒä½•ã‚’æŒ‡ã—ã¦ã‚‹ã®ã‹ã‚’æ›¸ãä¸‹ã‚ã›ã°å®Œæˆã§ã™

```rust
// å†æ²
use wasm_bindgen::closure::WasmClosure;
use wasm_bindgen::closure::WasmClosureFnOnce;

pub fn closure_once<F, A, R, T,>(fn_once: F,) -> Closure<T,>
where
	F: WasmClosureFnOnce<T, A, R,>,
	T: WasmClosure + ?Sized,
{
	Closure::once(fn_once,)
}
```

`F`,`T`ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã«staticã‚’æŒ‡å®šã—ã¦ã„ãªã„ã§ã™ãŒã€ã©ã†ã‚„ã‚‰`WasmClosureFnOnce`ã®åˆ¶ç´„è‡ªä½“ã«`'static`ãŒã‚ã‚‹æ§˜ã§ã™ã—ã€ä»Šã®æ‰€æŒ‡å®šã—ãªãã¦ã‚‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«é€šã£ã¦ã„ã‚‹ã®ã§ç„¡ãã¦ã‚‚ã„ã£ã‹ã€ã¨è¨€ã†ãŠæ°—æŒã¡
